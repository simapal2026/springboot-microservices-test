name: Agentic Code Quality & Test Auto-Remediation

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  agentic-remediation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Run tests & static analysis
        run: |
          mvn test || true
          mvn spotbugs:spotbugs pmd:pmd || true

      - name: Collect reports
        run: |
          mkdir -p agent-input
          cp target/spotbugsXml.xml agent-input/spotbugs.xml || true
          cp target/pmd.xml agent-input/pmd.xml || true

      - name: Run LLM agent to fix code and add tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          curl https://api.openai.com/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $OPENAI_API_KEY" \
          -d '{
              "model": "gpt-4.1",
              "messages": [
              {"role": "system", "content": "You are a senior Java engineer agent."},
              {"role": "user", "content": "Read SpotBugs and PMD reports and fix violations. Generate missing JUnit tests."}
                        ]
              }' > agent-output.json

          jq -r '.choices[0].message.content' agent-output.json > agent.patch
          git apply agent.patch || echo "No patch applied"

      - name: Run tests again
        run: mvn test

      - name: Create remediation PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: agentic-remediation-${{ github.run_id }}
          title: "ðŸ¤– Auto-remediation: code quality + tests"
          body: |
            Auto-generated by Agentic Workflow.
            - Fixed static analysis issues
            - Added missing unit tests
