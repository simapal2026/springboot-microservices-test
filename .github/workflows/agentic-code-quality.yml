name: Agentic Code Quality & Test Auto-Remediation

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  agentic-remediation:
    # Prevent infinite loop when bot creates PR
    if: github.event.pull_request.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the PR BRANCH (not detached commit)
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 3Ô∏è‚É£ Run tests and static analysis (don‚Äôt fail pipeline yet)
      - name: Run tests and static analysis
        run: |
          mvn test || true
          mvn spotbugs:spotbugs pmd:pmd || true

      # 4Ô∏è‚É£ Collect reports
      - name: Collect analysis reports
        run: |
          mkdir -p agent-input
          cp target/spotbugsXml.xml agent-input/spotbugs.xml || true
          cp target/pmd.xml agent-input/pmd.xml || true

      # 5Ô∏è‚É£ Run LLM agent to fix code and add tests
      - name: Run AI remediation agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > prompt.json << 'EOF'
          {
            "model": "gpt-4.1",
            "messages": [
              {
                "role": "system",
                "content": "You are a senior Java Spring Boot engineer acting as an automated remediation agent."
              },
              {
                "role": "user",
                "content": "Read SpotBugs and PMD reports in agent-input. Fix violations in src/main/java. Generate missing JUnit 5 unit tests in src/test/java using Mockito if needed. Do NOT change business logic. Output a unified diff patch only."
              }
            ]
          }
          EOF

          curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @prompt.json > agent-output.json

          jq -r '.choices[0].message.content' agent-output.json > agent.patch

          echo "===== PATCH FROM AGENT ====="
          cat agent.patch

          git apply agent.patch || echo "No patch applied"

      # 6Ô∏è‚É£ Run tests again after remediation
      - name: Run tests after remediation
        run: mvn test

      # 7Ô∏è‚É£ Create remediation PR
      - name: Create remediation PR
        uses: peter-evans/create-pull-request@v6
        with:
          base: ${{ github.base_ref }}
          branch: agentic-remediation-${{ github.run_id }}
          title: "ü§ñ Auto-remediation: code quality + unit tests"
          body: |
            This PR was automatically generated by the Agentic Workflow.

            Fixes:
            - Static analysis violations (SpotBugs, PMD)
            - Added missing JUnit 5 unit tests
            - Improved test coverage

            Please review carefully before merging.
